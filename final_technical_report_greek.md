# Τεχνική Αναφορά Υλοποίησης Συστήματος (Rasa Chatbot & Exam Generator)

## 1. Εισαγωγή
Η παρούσα αναφορά περιγράφει την τεχνική υλοποίηση ενός διαλογικού πράκτορα (Chatbot) για εκπαιδευτική χρήση. Το σύστημα επιτρέπει την αυτοματοποιημένη δημιουργία διαγωνισμάτων σε μορφή PDF, την αναζήτηση πληροφοριών από την ιστοσελίδα του σχολείου και την προσωποποιημένη αλληλεπίδραση ανάλογα με τον ρόλο του χρήστη (Μαθητής, Γονέας, Εκπαιδευτικός).

---

## 2. Αρχιτεκτονική Συστήματος & Εργαλεία

Για την ανάπτυξη και λειτουργία του συστήματος χρησιμοποιήθηκαν οι εξής τεχνολογίες:

### 2.1 Πυρήνας Chatbot (Rasa Framework)
*   **Rasa Open Source (v3.x):** Χρησιμοποιήθηκε για την κατανόηση φυσικής γλώσσας (NLU) και τη διαχείριση διαλόγου (Core).
*   **Rasa SDK (Action Server):** Εκτελεί προσαρμοσμένο κώδικα Python για σύνθετες λειτουργίες (π.χ. δημιουργία PDF, αναζήτηση σε WordPress, fallback logic).

### 2.2 Βάση Δεδομένων & Διαχείριση Αρχείων
*   **SQLite3:** Χρησιμοποιήθηκε ως ελαφριά, file-based βάση δεδομένων (`questions.db`) για την αποθήκευση των ερωτήσεων, των απαντήσεων και των μεταδεδομένων (μάθημα, τάξη, δυσκολία, paths εικόνων).
*   **File System:** Τα αρχεία (εικόνες, PDF, Word docs) αποθηκεύονται σε κοινόχρηστους τόμους (volumes) ώστε να είναι προσβάσιμα τόσο από τον Action Server όσο και από τον Nginx.

### 2.3 Δημιουργία Εγγράφων
*   **ReportLab (Python Library):** Βιβλιοθήκη για τη δυναμική παραγωγή των αρχείων PDF με υποστήριξη Ελληνικών (DejaVu Sans).
*   **Python-docx:** Βιβλιοθήκη για την ανάγνωση και ανάλυση (parsing) των αρχείων Word που ανεβάζουν οι εκπαιδευτικοί.

### 2.4 Υποδομή & Deployment (DevOps)
*   **Docker & Docker Compose:** Όλο το σύστημα τρέχει σε containers (απομονωμένα περιβάλλοντα).
    *   `rasa`: Ο κύριος server AI.
    *   `action-server`: Ο server που τρέχει τον Python κώδικα.
    *   `nginx`: Web Server που λειτουργεί ως Reverse Proxy και εξυπηρετεί τα στατικά αρχεία.
    *   `certbot`: Διαχειρίζεται τα πιστοποιητικά SSL (Let's Encrypt).
*   **WordPress REST API:** Διασύνδεση με την ιστοσελίδα του σχολείου για αναζήτηση άρθρων σε πραγματικό χρόνο.

---

## 3. Διαδικασία Υλοποίησης (Λειτουργίες)

### 3.1 Ανάλυση Εγγράφων Word (The Parser)
Αναπτύξαμε τον αλγόριθμο `extract_questions_from_docx` στο αρχείο `actions.py` που:
1.  **Metadata Parsing:** Διαβάζει αυτόματα το Μάθημα, την Τάξη και τη Δυσκολία από την αρχή του εγγράφου (π.χ., "Subject: Μαθηματικά").
2.  **Content Parsing:** Χρησιμοποιεί **Regular Expressions (Regex)** για να εντοπίζει ερωτήσεις και απαντήσεις, ακόμα και αν η λέξη "ΑΠΑΝΤΗΣΗ" βρίσκεται σε επόμενη γραμμή.
3.  **Image Extraction:** Εντοπίζει και εξάγει αυτόματα τις εικόνες που περιέχονται στο έγγραφο, τις αποθηκεύει στον φάκελο `files/images` και ενημερώνει τη βάση δεδομένων.

### 3.2 Αποθήκευση & Upload (Database)
Το Custom Action `ActionUploadExamMaterial`:
1.  **Smart Path Detection:** Αν ο χρήστης δεν δώσει έγκυρο μονοπάτι αρχείου, ο αλγόριθμος σαρώνει το ιστορικό της συνομιλίας (history scan) για να βρει προηγούμενα μηνύματα που περιείχαν ονόματα αρχείων (.docx/.pdf).
2.  **Validation:** Ελέγχει την ύπαρξη του αρχείου και τον τύπο του.
3.  **Storage:** Αποθηκεύει τα δεδομένα στον πίνακα `questions` της SQLite.

### 3.3 Παραγωγή Διαγωνίσματος (PDF Generation)
Το Action `ActionCreateExamNew`:
1.  **Dynamic Filtering:** Επιλέγει τυχαίες ερωτήσεις βάσει Κριτηρίων (Μάθημα, Τάξη, Δυσκολία) χρησιμοποιώντας Custom SQL Function (`NORMALIZE`) για να αγνοεί τόνους και πεζά/κεφαλαία (accent insensitive search).
2.  **Polyglot Answer Extraction:** Χρησιμοποιεί ευρετική μέθοδο για να εντοπίσει τη σωστή απάντηση (π.χ. 'Α', 'B' ή 'Γ') είτε είναι στα Ελληνικά είτε στα Λατινικά, καθαρίζοντας τα δεδομένα από περιττούς χαρακτήρες.
3.  **Inline Answers:** Στο παραγόμενο PDF, οι απαντήσεις εμφανίζονται (προαιρετικά) με **μπλε χρώμα** ακριβώς κάτω από την ερώτηση, για άμεση επαλήθευση από τον μαθητή.

### 3.4 Έλεγχος Πρόσβασης & Χαιρετισμός (Auth & Greeting)
1.  **Role-Based Greeting:** Ο χρήστης ερωτάται κατά την έναρξη αν είναι Μαθητής, Γονέας ή Εκπαιδευτικός.
    *   *Μαθητής:* Προτείνεται βοήθεια για διάβασμα.
    *   *Γονέας:* Προτείνεται ενημέρωση για λειτουργικά θέματα.
    *   *Εκπαιδευτικός:* Ενεργοποιούνται οι λειτουργίες Upload.
2.  **Permissions:** Το `ActionCheckUploadPermissions` επιτρέπει το ανέβασμα υλικού μόνο σε χρήστες με ρόλο `administrator` ή `member`.

### 3.5 Αναζήτηση & Smart FAQ
Υλοποιήσαμε δύο μηχανισμούς πληροφόρησης:
1.  **ActionSearchArticles:** Ο χρήστης μπορεί να ψάξει οτιδήποτε (π.χ. "εκδρομή") και το bot καλεί το **WordPress REST API** (`/wp/v2/posts?search=...`) για να φέρει τα 3 πιο σχετικά άρθρα.
2.  **Smart FAQ:** Για συχνές ερωτήσεις (π.χ. "απουσίες"), το bot δίνει μια σύντομη απάντηση ΚΑΙ εκτελεί ταυτόχρονα αναζήτηση στο site για να φέρει τις πιο πρόσφατες ανακοινώσεις που σχετίζονται με το θέμα.
    *   *Security:* Χρησιμοποιούμε Fake User-Agent headers για να αποφύγουμε blocks από security plugins του WordPress.

### 3.6 Μηχανισμός Fallback (Αντιμετώπιση Λαθών)
Για να μην "κολλάει" ο διάλογος όταν το bot δεν καταλαβαίνει:
1.  Το `ActionHandleFallback` μετράει πόσες φορές συνεχόμενα απέτυχε η αναγνώριση (consecutive nlu_fallback).
2.  **< 3 αποτυχίες:** Ζητάει ευγενικά επανάληψη.
3.  **>= 3 αποτυχίες:** Κάνει Reset τη συζήτηση και εμφανίζει το μήνυμα: *"Συγνώμη αλλά δεν κατάλαβα. Θέλετε να με ρωτήσετε κάτι άλλο;"*.

---

## 4. Διαδικασία DevOps & Debugging

Κατά την ανάπτυξη αντιμετωπίσαμε και λύσαμε σημαντικά προβλήματα:

1.  **Font Issues:**
    *   *Πρόβλημα:* Η βιβλιοθήκη ReportLab δεν έβρισκε τα ελληνικά fonts στο Linux container.
    *   *Λύση:* Υλοποιήσαμε αλγόριθμο που ψάχνει δυναμικά το `DejaVuSans.ttf` σε πολλαπλά paths (`/app/fonts`, `C:/Windows/Fonts`) για να δουλεύει και σε Docker και σε Local Windows περιβάλλον.

2.  **Database Locking & Permissions:**
    *   Ρυθμίσαμε τα δικαιώματα φακέλων (`chmod 777`) και διασφαλίσαμε ότι η SQLite κλείνει τα connections (`conn.close()`) σωστά μετά από κάθε query.

3.  **SSL Errors στο Σχολικό Δίκτυο:**
    *   Κατά την κλήση του WordPress API, προσθέσαμε την παράμετρο `verify=False` για να παρακάμψουμε προβλήματα με self-signed ή ληγμένα πιστοποιητικά που συχνά εμφανίζονται σε σχολικά δίκτυα.

---

## 5. Συμπέρασμα
Το σύστημα είναι πλέον μια ολοκληρωμένη λύση που συνδυάζει **AI (Rasa)**, **Document Processing (Python)** και **Web Integration (WordPress)**. Είναι ανθεκτικό σε λάθη χρήστη (Fallback, Smart Path Detection), παρέχει ασφάλεια (Role-based Access) και προσφέρει πλούσιο εκπαιδευτικό υλικό με αυτόματη μορφοποίηση.
