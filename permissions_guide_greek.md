# Οδηγός Ασφάλειας και Δικαιωμάτων Χρηστών

Αυτό το έγγραφο αναλύει τεχνικά πώς υλοποιήσαμε το σύστημα ελέγχου πρόσβασης (Permissions), ώστε να διαχωρίσουμε τους εγγεγραμμένους χρήστες από τους επισκέπτες.

## 1. Η Φιλοσοφία της Ασφάλειας

Ο στόχος ήταν:
*   **Εγγεγραμμένοι Χρήστες (Members):** Να μπορούν να δημιουργούν διαγωνίσματα και να ανεβάζουν υλικό.
*   **Επισκέπτες (Δημόσιο):** Να μπορούν μόνο να κάνουν αναζήτηση άρθρων και να ρωτούν γενικές πληροφορίες.

Η υλοποίηση βασίζεται στα **Metadata** που στέλνει η ιστοσελίδα (WordPress) στο Chatbot κατά την έναρξη της συνομιλίας.

---

## 2. Ο Μηχανισμός Ελέγχου (`actions.py`)

Στο αρχείο `actions/actions.py`, δημιουργήσαμε μια κεντρική συνάρτηση-φρουρό που ονομάζεται `check_user_access`.

### Η Συνάρτηση `check_user_access`
Αυτή η συνάρτηση ελέγχει αν ο χρήστης είναι συνδεδεμένος.

```python
def check_user_access(tracker: Tracker) -> bool:
    """
    Ελέγχει αν ο χρήστης είναι αυθεντικοποιημένος μέσω Metadata.
    Επιστρέφει True αν επιτρέπεται, False αν όχι.
    """
    # 1. Έλεγχος στο τελευταίο μήνυμα
    metadata = tracker.latest_message.get("metadata", {})
    user_data = metadata.get("customData", {}) or metadata
    
    # Αν το 'role' είναι 'member' ή υπάρχει 'username', δώσε πρόσβαση
    if user_data.get("role") == "member" or user_data.get("username"):
        return True

    # 2. Αν δεν βρέθηκε, ψάξε στο ιστορικό (γιατί το Webchat το στέλνει μόνο στην αρχή)
    for event in reversed(tracker.events):
        # ... (κώδικας που σκανάρει το ιστορικό για metadata) ...
        if role == "member" or username:
            return True
            
    return False
```

---

## 3. Εφαρμογή στις Λειτουργίες

### Α. Δημιουργία Διαγωνίσματος (Προστατευμένο)
Όταν ο κώδικας πάει να εκτελέσει το `ActionCreateExamNew`, το πρώτο πράγμα που κάνει είναι να καλέσει τον "φρουρό".

```python
class ActionCreateExamNew(Action):
    def run(self, dispatcher, tracker, domain):
        
        # --- ΕΛΕΓΧΟΣ ΑΣΦΑΛΕΙΑΣ ---
        if not check_user_access(tracker):
            dispatcher.utter_message(text="🚫 Αυτή η λειτουργία είναι διαθέσιμη μόνο για εγγεγραμμένους χρήστες...")
            return [] # Σταματάει εδώ και δεν κάνει τίποτα άλλο
        # -------------------------

        # ... (Αν περάσει τον έλεγχο, συνεχίζει κανονικά) ...
```

### Β. Αναζήτηση Άρθρων (Δημόσιο)
Στο `ActionSearchArticles`, **δεν** καλούμε ποτέ την `check_user_access`. Έτσι, η πόρτα είναι ανοιχτή για όλους.

```python
class ActionSearchArticles(Action):
    def run(self, dispatcher, tracker, domain):
        
        # Κανένας έλεγχος εδώ!
        
        query = tracker.get_slot("query")
        # ... (Εκτελεί την αναζήτηση κανονικά για όλους) ...
```

---

## 4. Συμπέρασμα
Το σύστημα είναι ασφαλές επειδή ο έλεγχος γίνεται στον **Server (Backend)**. Ακόμα και αν κάποιος προσπαθήσει να ξεγελάσει το Chatbot ζητώντας επίμονα "φτιάξε μου διαγώνισμα", ο Python κώδικας στον server θα ελέγξει την ταυτότητά του και θα του απαγορεύσει την πρόσβαση αν δεν είναι μέλος.
